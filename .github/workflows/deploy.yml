name: Deploy Firecrawl to VPS go

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Ensure git is installed
            if ! command -v git &> /dev/null; then
              echo "Git is not installed. Installing..."
              sudo apt-get update && sudo apt-get install -y git
            fi

            # Ensure Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "Docker is not installed. Installing..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
            fi

            # Setup directory
            mkdir -p ~/firecrawl
            cd ~/firecrawl

            # Clone or Pull repository
            if [ -d ".git" ]; then
              echo "Pulling latest changes..."
              git pull origin main
            else
              echo "Cloning repository..."
              # Use PAT for authentication if needed, or public clone
              # Assuming public or PAT in URL. Using PAT is safer for private.
              if [ -n "${{ secrets.GH_PAT }}" ]; then
                git clone https://${{ secrets.GH_USER }}:${{ secrets.GH_PAT }}@github.com/jabjab42/firecrawl.git .
              else
                git clone https://github.com/jabjab42/firecrawl.git .
              fi
            fi

            # Create .env file from secrets
            echo "Creating .env file..."
            cat <<EOF > .env
            PORT=${{ secrets.FIRECRAWL_PORT }}
            HOST=${{ secrets.FIRECRAWL_HOST }}
            USE_DB_AUTHENTICATION=${{ secrets.FIRECRAWL_USE_DB_AUTHENTICATION }}
            BULL_AUTH_KEY=${{ secrets.FIRECRAWL_BULL_AUTH_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            AUTH_TOKEN=${{ secrets.AUTH_TOKEN }}
            # Add other secrets as needed
            EOF

            # Login to GHCR if needed (for official images)
            if [ -n "${{ secrets.GH_PAT }}" ]; then
              echo ${{ secrets.GH_PAT }} | docker login ghcr.io -u ${{ secrets.GH_USER }} --password-stdin
            fi

            # Build and Start
            echo "Building and starting services..."
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans
            
            # Prune unused images to save space
            docker image prune -f
